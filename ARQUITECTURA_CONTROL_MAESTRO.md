# ğŸ—ï¸ ARQUITECTURA - CENTRO DE CONTROL MAESTRO

## Flujo General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NAVEGADOR WEB                                â”‚
â”‚          http://localhost:8081                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                    â”‚
                â–¼                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  /login       â”‚    â”‚  /            â”‚
        â”‚               â”‚    â”‚ (redirige)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚
         â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Maestro    â”‚ â”‚  Admin/Cajero  â”‚
    â”‚  @gmail...  â”‚ â”‚  @gmail...     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚
           â”‚ rol=super...    â”‚ rol=admin...
           â”‚                 â”‚
           â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MAESTRO     â”‚  â”‚ ADMIN        â”‚
    â”‚ LAYOUT       â”‚  â”‚ LAYOUT       â”‚
    â”‚              â”‚  â”‚              â”‚
    â”‚ /control-    â”‚  â”‚ /admin/      â”‚
    â”‚ maestro      â”‚  â”‚ usuarios     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚
           â–¼                 â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   ControlMaestro.vue        â”‚
       â”‚   ListaUsuarios.vue         â”‚
       â”‚   CrearUsuario.vue          â”‚
       â”‚   EditarUsuario.vue         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ HTTP/AJAX
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     BACKEND API (PHP)        â”‚
    â”‚                              â”‚
    â”‚  /api/empresas.php   â† NUEVA â”‚
    â”‚  /api/usuarios.php          â”‚
    â”‚  /api/auth.php              â”‚
    â”‚  /api/roles.php             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   MySQL Database         â”‚
    â”‚   gestorxbd              â”‚
    â”‚                          â”‚
    â”‚  â”œâ”€â”€ usuario             â”‚
    â”‚  â”œâ”€â”€ rol                 â”‚
    â”‚  â”œâ”€â”€ empresa             â”‚
    â”‚  â”œâ”€â”€ permiso             â”‚
    â”‚  â”œâ”€â”€ rol_permiso         â”‚
    â”‚  â””â”€â”€ ...                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estructura de la AplicaciÃ³n

```
C:\xampp\htdocs\GestorX\
â”‚
â”œâ”€â”€ DOCUMENTACIÃ“N
â”‚   â”œâ”€â”€ CONTROL_MAESTRO_DOCUMENTACION.md      (DocumentaciÃ³n completa)
â”‚   â”œâ”€â”€ CONTROL_MAESTRO_RESUMEN.md            (Resumen tÃ©cnico)
â”‚   â”œâ”€â”€ CONTROL_MAESTRO_INICIO_RAPIDO.md      (GuÃ­a rÃ¡pida)
â”‚   â””â”€â”€ CAMBIOS_CONTROL_MAESTRO.md            (Registro de cambios)
â”‚
â”œâ”€â”€ gestorx/                                    (Frontend Vue.js)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ router/
â”‚       â”‚   â””â”€â”€ index.js                       (ğŸ”„ MODIFICADO: +ruta maestro)
â”‚       â”‚
â”‚       â”œâ”€â”€ views/
â”‚       â”‚   â”œâ”€â”€ ControlMaestro.vue             (âœ¨ NUEVO)
â”‚       â”‚   â”œâ”€â”€ Login.vue
â”‚       â”‚   â”œâ”€â”€ Dashboard.vue
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ Layout/
â”‚       â”‚       â”œâ”€â”€ MaestroLayout.vue          (âœ¨ NUEVO)
â”‚       â”‚       â”œâ”€â”€ AdminLayout.vue
â”‚       â”‚       â””â”€â”€ UserLayout.vue
â”‚       â”‚
â”‚       â””â”€â”€ Usuarios/
â”‚           â”œâ”€â”€ ListaUsuarios.vue
â”‚           â”œâ”€â”€ CrearUsuario.vue
â”‚           â””â”€â”€ EditarUsuario.vue
â”‚
â”œâ”€â”€ gestorx-backend/                           (Backend PHP)
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ empresas.php                       (âœ¨ NUEVO - API maestro)
â”‚   â”‚   â”œâ”€â”€ auth.php
â”‚   â”‚   â”œâ”€â”€ usuarios.php
â”‚   â”‚   â”œâ”€â”€ roles.php
â”‚   â”‚   â””â”€â”€ registro.php
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.php
â”‚   â”‚   â”œâ”€â”€ Initializer.php
â”‚   â”‚   â””â”€â”€ Seeder.php                        (ğŸ”„ MODIFICADO: +datos maestro)
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ Usuario.php                        (ğŸ”„ MODIFICADO: soporta NULL)
â”‚   â”‚   â””â”€â”€ Empresa.php
â”‚   â”‚
â”‚   â”œâ”€â”€ middlewares/
â”‚   â”‚   â”œâ”€â”€ AuthMiddleware.php                (ğŸ”„ MODIFICADO: namespace)
â”‚   â”‚   â””â”€â”€ CorsMiddleware.php
â”‚   â”‚
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â””â”€â”€ JWT.php
â”‚   â”‚
â”‚   â””â”€â”€ init.php                              (Ejecutar para cargar BD)
â”‚
â””â”€â”€ DATABASE_SCHEMA.sql                        (Esquema BD)
```

---

## Relaciones de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         USUARIO                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id_usuario        (PK)          â”‚
â”‚ id_empresa   (FK) [NULL OK] â—„â”€â”€â”â”‚
â”‚ id_rol       (FK) â—„â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚ nombre            â”‚       â”‚ â”‚  â”‚
â”‚ apellido          â”‚       â”‚ â”‚  â”‚
â”‚ correo            â”‚       â”‚ â”‚  â”‚
â”‚ password_hash     â”‚       â”‚ â”‚  â”‚
â”‚ estado_usuario    â”‚       â”‚ â”‚  â”‚
â”‚ fecha_creacion    â”‚       â”‚ â”‚  â”‚
â”‚ ultimo_acceso     â”‚       â”‚ â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”˜
                   â”‚â•‘       â”‚ â”‚
                   â”‚â•‘       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚â•‘       â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â•‘       â”‚    â”‚   EMPRESA        â”‚
    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â•¨â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       â”‚               â”‚    â”‚ id_empresa  (PK) â”‚
    â”‚       â”‚         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â–ºid_plan      (FK) â”‚
    â”‚       â”‚         â”‚          â”‚ nombre_comercial â”‚
    â–¼       â–¼         â”‚          â”‚ estado_empresa   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚          â”‚ fecha_registro   â”‚
â”‚    ROL      â”‚       â”‚          â”‚ fecha_expiracion â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ id_rol (PK) â”‚       â”‚
â”‚ nombre_rol  â”‚       â”‚
â”‚ descripcion â”‚       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
      â”‚               â”‚
      â”‚ M:M           â”‚
      â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  ROL_PERMISO     â”‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ id_rol      (FK) â”œâ”€â”€â”˜
â”‚ id_permiso  (FK) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PERMISO     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚id_permiso(PK)â”‚
    â”‚nombre_permisoâ”‚
    â”‚modulo        â”‚
    â”‚descripcion   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Login - Caso Maestro

```
USUARIO: maestro@gestorx.test
PASSWORD: Maestro@2026

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. POST /api/auth.php       â”‚
    â”‚    {                        â”‚
    â”‚      action: "login"        â”‚
    â”‚      correo: "maestro..."   â”‚
    â”‚      password: "Maestro..." â”‚
    â”‚    }                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Usuario.login()          â”‚
    â”‚    LEFT JOIN empresa        â”‚
    â”‚    Query busca en BD        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Verifica contraseÃ±a      â”‚
    â”‚    password_verify()        â”‚
    â”‚    âœ“ COINCIDE               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. Verifica estado empresa  â”‚
    â”‚    id_empresa = NULL        â”‚
    â”‚    â†’ SALTA VALIDACIÃ“N       â”‚
    â”‚    âœ“ PERMITIDO              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. Genera JWT Token         â”‚
    â”‚    {                        â”‚
    â”‚      id_usuario: 1          â”‚
    â”‚      id_empresa: null       â”‚
    â”‚      rol: "superadministrador"
    â”‚      nombre: "Control Maestro"
    â”‚      empresa: "Control Maestro"
    â”‚    }                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. Response (200 OK)        â”‚
    â”‚    {                        â”‚
    â”‚      success: true          â”‚
    â”‚      token: "eyJ..."        â”‚
    â”‚      user: {...}            â”‚
    â”‚    }                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 7. Frontend almacena        â”‚
    â”‚    localStorage.setItem(    â”‚
    â”‚      'token', token         â”‚
    â”‚    )                        â”‚
    â”‚    localStorage.setItem(    â”‚
    â”‚      'user', user           â”‚
    â”‚    )                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 8. Router guard verifica    â”‚
    â”‚    user.rol = 'super...'    â”‚
    â”‚    â†’ next('/control-maestro')
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 9. MaestroLayout renderiza  â”‚
    â”‚    - Sidebar                â”‚
    â”‚    - Header                 â”‚
    â”‚    - ControlMaestro.vue     â”‚
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 10. Cargar empresas         â”‚
    â”‚     GET /api/empresas.php   â”‚
    â”‚     Header:                 â”‚
    â”‚     Authorization: Bearer.. â”‚
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 11. AuthMiddleware valida   â”‚
    â”‚     - Token vÃ¡lido âœ“        â”‚
    â”‚     - rol = super... âœ“      â”‚
    â”‚     â†’ ACCESO PERMITIDO      â”‚
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 12. Retorna empresas        â”‚
    â”‚     Response (200):         â”‚
    â”‚     {                       â”‚
    â”‚       data: [...]           â”‚
    â”‚       total: 5              â”‚
    â”‚     }                       â”‚
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ“ Control Maestro cargado   â”‚
    â”‚   Listo para usar           â”‚
    â”‚                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Suspender Empresa

```
USUARIO CLICKEA: "ğŸ”’ Suspender" en empresa "GestorX Demo"

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. toggleEmpresa()               â”‚
    â”‚    id_empresa = 1                â”‚
    â”‚    estado_actual = 'activa'      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Abre Modal de ConfirmaciÃ³n    â”‚
    â”‚    "Â¿Suspender GestorX Demo?"    â”‚
    â”‚    "Sus usuarios no podrÃ¡n..."   â”‚
    â”‚    [Cancelar] [Confirmar]        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼ USUARIO CLICKEA "Confirmar"
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. confirmarDesactivar()         â”‚
    â”‚    PUT /api/empresas.php?id=1    â”‚
    â”‚    Headers:                      â”‚
    â”‚    Authorization: Bearer ...     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. Backend: desactivarEmpresa()  â”‚
    â”‚    - Valida token âœ“             â”‚
    â”‚    - Verifica rol=super... âœ“    â”‚
    â”‚    - Obtiene estado actual      â”‚
    â”‚    - Alterna: activa â†’ suspendida
    â”‚    - UPDATE empresa SET estado  â”‚
    â”‚    - WHERE id_empresa = 1       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. BD actualiza                  â”‚
    â”‚    UPDATE empresa SET            â”‚
    â”‚      estado_empresa='suspendida' â”‚
    â”‚    WHERE id_empresa=1            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. Response (200 OK):            â”‚
    â”‚    {                             â”‚
    â”‚      success: true,              â”‚
    â”‚      message: "Empresa suspend..",
    â”‚      id_empresa: 1,              â”‚
    â”‚      estado_nuevo: "suspendida"  â”‚
    â”‚    }                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 7. Frontend:                     â”‚
    â”‚    - mostrarToast("Empresa...")  â”‚
    â”‚    - cargarEmpresas() [reload]   â”‚
    â”‚    - cerrarModal()               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 8. Tabla actualiza:              â”‚
    â”‚    GestorX Demo:                 â”‚
    â”‚    Estado: âŠ˜ Suspendida (rojo)   â”‚
    â”‚    BotÃ³n: "ğŸ”“ Activar"           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AHORA: Usuarios no pueden login  â”‚
    â”‚                                  â”‚
    â”‚ Si intenta: admin@gestorx.test   â”‚
    â”‚ Usuario.login():                 â”‚
    â”‚ - Query: LEFT JOIN empresa       â”‚
    â”‚ - Resultado: estado='suspendida' â”‚
    â”‚ - Retorna: FALSE                 â”‚
    â”‚ - Response: "Credenciales..."    â”‚
    â”‚                                  â”‚
    â”‚ âŒ LOGIN DENEGADO               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estructura de Roles

```
ANTES:                          DESPUÃ‰S:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROL              â”‚           â”‚ ROL                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1: superadmin    â”‚           â”‚ 1: superadmin         â”‚ â† SIN EMPRESA
â”‚ 2: admin         â”‚           â”‚ 2: admin              â”‚ â† DENTRO EMPRESA
â”‚ 3: gerente       â”‚           â”‚ 3: (ELIMINADO)        â”‚
â”‚ 4: cajero        â”‚           â”‚ 4: cajero             â”‚
â”‚ 5: almacenero    â”‚           â”‚ 5: almacenero         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    Cambio: Gerente no existe por empresa
                                    (Era admin de empresa, ahora solo admin global)
```

---

## IntegraciÃ³n de APIs

```
FRONTEND REQUEST:
GET /api/empresas.php?usuarios=1

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APACHE/HTACCESS ROUTING                          â”‚
â”‚ /api/empresas.php â†’                              â”‚
â”‚ /gestorx-backend/api/empresas.php               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api/empresas.php                                 â”‚
â”‚ â”œâ”€â”€ Valida token JWT (AuthMiddleware)            â”‚
â”‚ â”œâ”€â”€ Verifica role (superadministrador)           â”‚
â”‚ â”œâ”€â”€ ParÃ¡metros $_GET['usuarios']                 â”‚
â”‚ â”œâ”€â”€ Llama listarUsuariosEmpresa($conn, 1)        â”‚
â”‚ â””â”€â”€ Retorna JSON                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ejecuta SQL Query:                               â”‚
â”‚ SELECT u.*, r.nombre_rol                         â”‚
â”‚ FROM usuario u                                   â”‚
â”‚ LEFT JOIN rol r ON ...                           â”‚
â”‚ LEFT JOIN empresa e ON ...                       â”‚
â”‚ WHERE u.id_empresa = 1                           â”‚
â”‚ ORDER BY u.fecha_creacion DESC                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response JSON:                                   â”‚
â”‚ {                                                â”‚
â”‚   "success": true,                               â”‚
â”‚   "data": [                                      â”‚
â”‚     {                                            â”‚
â”‚       "id_usuario": 2,                           â”‚
â”‚       "nombre": "Admin",                         â”‚
â”‚       "correo": "admin@gestorx.test",            â”‚
â”‚       "nombre_rol": "administrador",             â”‚
â”‚       "estado_usuario": "activo"                 â”‚
â”‚     },                                           â”‚
â”‚     ...                                          â”‚
â”‚   ],                                             â”‚
â”‚   "total": 5                                     â”‚
â”‚ }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND:                                        â”‚
â”‚ â”œâ”€â”€ axios.get() recibe response                  â”‚
â”‚ â”œâ”€â”€ Valida response.data.success                 â”‚
â”‚ â”œâ”€â”€ this.usuariosEmpresa = response.data.data    â”‚
â”‚ â”œâ”€â”€ Vue re-renderiza tabla                       â”‚
â”‚ â””â”€â”€ Muestra usuarios en modal                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Seguridad - Validaciones en Cascada

```
REQUEST TO /api/empresas.php

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. Existe Authorization header? â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ NO
                 â”œâ”€â”€â”€â”€â”€â–º HTTP 401 âŒ
                 â”‚
                 â”‚ SÃ
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Token JWT vÃ¡lido?            â”‚
    â”‚    JWT::decode($token)          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ INVÃLIDO
                 â”œâ”€â”€â”€â”€â”€â–º HTTP 401 âŒ
                 â”‚
                 â”‚ VÃLIDO
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Empresa activa?              â”‚
    â”‚    (si id_empresa != NULL)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ SUSPENDIDA
                 â”œâ”€â”€â”€â”€â”€â–º HTTP 403 âŒ
                 â”‚
                 â”‚ ACTIVA/NULL
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. Rol es superadministrador?   â”‚
    â”‚    if ($user['id_rol'] != 1)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ NO
                 â”œâ”€â”€â”€â”€â”€â–º HTTP 403 âŒ
                 â”‚
                 â”‚ SÃ
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ“ ACCESO PERMITIDO              â”‚
    â”‚ Ejecuta funciÃ³n solicitada      â”‚
    â”‚ Retorna datos                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CachÃ© y Rendimiento

```
PRIMERA CARGA (FrÃ­o):
Frontend â†’ GET /api/empresas.php
         â†’ BD query (todas las empresas)
         â†’ JSON response
         â†’ Renderiza tabla
         â±ï¸ ~500-800ms

BÃšSQUEDA (Cliente):
Usuario digita en input
         â†’ Vue calcula empresasFiltradas
         â†’ Filtra array en memoria
         â±ï¸ ~0-5ms

CAMBIO DE ESTADO:
Usuario suspende empresa
         â†’ PUT /api/empresas.php?id=1
         â†’ BD update
         â†’ GET /api/empresas.php (reload completo)
         â†’ Renderiza tabla actualizada
         â±ï¸ ~500-800ms

SEGUNDA CARGA (Con datos en cache):
Frontend tiene empresas en this.empresas
         â†’ Vuelve a GET /api/empresas.php
         â†’ BD query (sin cache en servidor)
         â†’ JSON response
         â±ï¸ ~500-800ms (igual, sin cachÃ© en servidor)

SUGERENCIA: Implementar Redis o cachÃ© en BD
```

---

**Diagrama actualizado:** 15-01-2026  
**VersiÃ³n:** 1.0  
**Estado:** âœ… COMPLETO
